<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <!-- Licensed under the Apache License, Version 2.0 (the "License"); you may not
     * use this file except in compliance with the License. You may obtain a copy of
     * the License at
     *
     * http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
     * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
     * License for the specific language governing permissions and limitations under
     * the License
    -->
    <ModulePrefs title="Wakatime Gadget">
        <Require feature="rpc" />
        <Require feature="views" />
        <Require feature="locked-domain" />
    </ModulePrefs>
    <Content type="html"><![CDATA[
<html ng-app="wakatime">
<head>
<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.min.css" />
<style>

</style>
<!-- inject:css -->
<!-- endinject -->
</head>
<body ng-controller="WakatimeCtrl">

<script src="//plus.google.com/hangouts/_/api/v1/hangout.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.11/angular.min.js"></script>


<form class="form-inline">
    <div class="form-group">
        <img src="https://avatars2.githubusercontent.com/u/4814844?v=3&s=200">
    </div>
    <div class="form-group">
        <input id="api_key" name="api_key" ng-model="apiKey" placeholder="API Key">
    </div>
    <div class="form-group">
        <input id="project" name="project" ng-model="project" placeholder="Project">
    </div>
    <div class="form-group">
        <input type="checkbox" ng-model="showLogo">
    </div>
    <div class="form-group">
        <div class="btn-group">
            <button class="btn btn-success" ng-click="start()" ng-hide="running" type="button">Start</button>
            <button class="btn btn-danger" ng-click="stop()" ng-show="running" type="button">Stop</button>
            <button class="btn btn-default" ng-click="reset()" type="button">Reset</button>
        </div>
    </div>
</form>




<script>
/* global angular, gapi, gadgets, moment, $ */

(function() {
    'use strict';

    var app = angular.module('wakatime', []);

    app.factory('Hangout', function ($rootScope, $interval) {
        var overlays = {};
        var watch;
        var time = 0;

        function createTextOverlay(string) {
            // Create a canvas to draw on
            var canvas = document.createElement('canvas');
            canvas.setAttribute('width', 166);
            canvas.setAttribute('height', 100);

            var context = canvas.getContext('2d');

            // Draw text
            context.font = '16pt Impact';
            context.lineWidth = 6;
            context.lineStyle = '#000';
            context.fillStyle = '#FFF';
            context.textAlign = 'center';
            context.textBaseline = 'bottom';
            context.strokeText(string, canvas.width / 2, canvas.height / 2);
            context.fillText(string, canvas.width / 2, canvas.height / 2);

            return canvas.toDataURL();
        }

        var Hangout = {
            init: function() {
                gapi.hangout.onParticipantsChanged.add(
                    function(e) {
                        $rootScope.$broadcast('hangout.participant', e);
                    });

                gapi.hangout.onair.onBroadcastingChanged.add(
                    function(e) {
                        $rootScope.$broadcast('hangout.broadcasting', e);
                    });

                gapi.hangout.onair.onNewParticipantInBroadcastChanged.add(
                    function(e) {
                    });

                gapi.hangout.onTopicChanged.add(
                    function(e) {
                        $rootScope.$broadcast('hangout.topic', e);
                    });
            },
            start: function() {
                if(watch) {
                    return;
                } else {
                    Hangout.setTime(moment(time).format('HH:mm:ss'));
                    watch = $interval(function() {
                        time += 5000;
                        Hangout.setTime(moment(time).format('HH:mm:ss'));
                    }, 5000)
                }
            },
            stop: function() {
                if(watch) {
                    $interval.cancel(watch);
                    watch = undefined;
                }
            },
            reset: function() {
                time = 0;
            },
            setTime: function(time) {
                var overlay = gapi.hangout.av.effects.createImageResource(createTextOverlay(time));
                overlay = overlay.createOverlay({
                    'scale': {
                        'magnitude': 0.4,
                        'reference': gapi.hangout.av.effects.ScaleReference.WIDTH
                    }
                });
                overlay.setPosition(-0.5, 0.5);
                overlay.setVisible(true);

                if(overlays['time']) {
                    overlays['time'].dispose();
                }

                overlays['time'] = overlay;
            },
            showLogo: function(show) {
                if(!overlays['logo']) {
                    overlays['logo'] = gapi.hangout.av.effects.createImageResource('https://avatars2.githubusercontent.com/u/4814844?v=3&s=200');
                    overlays['logo'] = overlays['logo'].createOverlay({
                        'scale': {
                            'magnitude': 0.5,
                            'reference': gapi.hangout.av.effects.ScaleReference.WIDTH
                        }
                    });
                    overlays['logo'].setPosition(0.5, 0.45);
                }
                overlays['logo'].setVisible(show);
            }
        };

        // Wait for gadget to load.
        gadgets.util.registerOnLoadHandler(function() {
            gapi.hangout.onApiReady.add(
                function(e) {
                    Hangout.init();
                });
        });

        return Hangout;
    });

    app.controller('WakatimeCtrl', function ($scope, $http, Hangout) {
        $scope.edit = true;
        $scope.running = false;
        $scope.logo = 'https://avatars2.githubusercontent.com/u/4814844?v=3&s=200';

        $scope.start = function() {
            Hangout.start();
        };

        $scope.stop = function() {
            Hangout.stop();
        };

        $scope.reset = function() {
            Hangout.reset();
        };

        $scope.$watch('showLogo', function(newValue, oldValue) {
            Hangout.showLogo(newValue);
        });

        $scope.sendHeartbeat = function(file, time, project, language, isWrite, lines) {
            // TODO
        };
    });

})();
</script>
<!-- inject:js -->
<!-- endinject -->
</body>
]]>
    </Content>
</Module>
